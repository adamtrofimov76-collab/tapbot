<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–§–µ—Ä–º–∞ WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#fff; max-width:680px; margin:0 auto; padding:16px; }
    .card { background:#1b1b1b; border-radius:12px; padding:12px; margin-bottom:12px; }
    button { width:100%; padding:12px; margin:6px 0; border:none; border-radius:10px; background:#2f80ed; color:#fff; font-size:16px; }
    .small { font-size:14px; opacity:0.85 }
    .top-item { padding:6px 0; border-bottom:1px solid #333; }
    .tap-zone {
      user-select:none;
      -webkit-user-select:none;
      touch-action:manipulation;
      width:100%;
      min-height:170px;
      border-radius:14px;
      border:2px dashed #4a4a4a;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-size:26px;
      font-weight:bold;
      background:#222;
      margin-bottom:8px;
      cursor:pointer;
    }
    .tap-zone:active { transform: scale(0.99); background:#2a2a2a; }
  </style>
</head>
<body>
  <h2>üåæ –§–µ—Ä–º–∞ ‚Äî Web</h2>
  <div class="card">
    <label>–í–∞—à Telegram user_id</label>
    <input id="uid" style="width:100%;padding:8px;border-radius:8px;border:1px solid #555;background:#222;color:#fff" />
    <button onclick="loadProfile()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
  </div>

  <div class="card">
    <div id="status">–ù–∞–∂–º–∏ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"</div>
    <div class="small" id="msg"></div>
  </div>

  <div class="card">
    <div id="tapZone" class="tap-zone">üëá –¢–ê–ü–ê–ô –ó–î–ï–°–¨ üëá</div>
    <div class="small" id="tapInfo">–¢–∞–ø–æ–≤ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏: 0</div>

    <button id="upTapBtn" onclick="doAction('/api/upgrade/tap')">‚ö° –£–ª—É—á—à–∏—Ç—å —Ç–∞–ø</button>
    <button id="upRegenBtn" onclick="doAction('/api/upgrade/regen')">üöÄ –£–ª—É—á—à–∏—Ç—å —Ä–µ–≥–µ–Ω</button>
    <button id="buyEnergyBtn" onclick="doAction('/api/buy-energy')">üíµ –ö—É–ø–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é</button>
    <button id="autoFarmBtn" onclick="doAction('/api/upgrade/auto-farm')">ü§ñ –ê–≤—Ç–æ-—Ñ–∞—Ä–º</button>
  </div>

  <div class="card">
    <button onclick="loadTop('balance')">üí∞ –¢–æ–ø –±–∞–ª–∞–Ω—Å</button>
    <button onclick="loadTop('auto-farm')">ü§ñ –¢–æ–ø –∞–≤—Ç–æ-—Ñ–∞—Ä–º</button>
    <button onclick="loadTop('regen')">üöÄ –¢–æ–ø —Ä–µ–≥–µ–Ω</button>
    <div id="top"></div>
  </div>

<script>
  let userId = null;
  let tapCount = 0;
  let tapInFlight = false;

  function body() { return { user_id: Number(userId) }; }

  function render(data) {
    document.getElementById('status').innerText =
      `üí∞ –ë–∞–ª–∞–Ω—Å: ${data.balance}\n‚ö° –≠–Ω–µ—Ä–≥–∏—è: ${data.energy}\n‚ö° Tap: ${data.tap_power}\nüöÄ –†–µ–≥–µ–Ω: ${data.energy_regen}/—Å–µ–∫\nü§ñ –ê–≤—Ç–æ-—Ñ–∞—Ä–º: ${data.auto_farm_level}/—Å–µ–∫`;
    document.getElementById('msg').innerText = data.message;
    document.getElementById('upTapBtn').innerText = `‚ö° –£–ª—É—á—à–∏—Ç—å —Ç–∞–ø ‚Ä¢ ${data.costs.tap_upgrade}üí∞`;
    document.getElementById('upRegenBtn').innerText = `üöÄ –£–ª—É—á—à–∏—Ç—å —Ä–µ–≥–µ–Ω ‚Ä¢ ${data.costs.regen_upgrade}üí∞`;
    document.getElementById('autoFarmBtn').innerText = `ü§ñ –ê–≤—Ç–æ-—Ñ–∞—Ä–º ‚Ä¢ ${data.costs.auto_farm_upgrade}üí∞`;
    document.getElementById('buyEnergyBtn').innerText = `üíµ –ö—É–ø–∏—Ç—å —ç–Ω–µ—Ä–≥–∏—é ‚Ä¢ ${data.costs.buy_energy}üí∞`;
  }

  function setupTelegramWebAppUser() {
    if (!window.Telegram || !window.Telegram.WebApp) return;
    const tg = window.Telegram.WebApp;
    tg.expand();

    const tgUserId = tg?.initDataUnsafe?.user?.id;
    if (tgUserId) {
      document.getElementById('uid').value = String(tgUserId);
      userId = String(tgUserId);
      loadProfile();
    }
  }

  async function loadProfile() {
    userId = document.getElementById('uid').value.trim();
    if (!userId) return alert('–í–≤–µ–¥–∏—Ç–µ user_id');
    const r = await fetch('/api/profile', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body()) });
    const data = await r.json();
    if (!r.ok) return alert(data.detail || '–û—à–∏–±–∫–∞');
    render(data);
  }

  async function doAction(url) {
    if (!userId) return alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Å—å');
    const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body()) });
    const data = await r.json();
    if (!r.ok) return alert(data.detail || '–û—à–∏–±–∫–∞');
    render(data);
  }

  async function doTap() {
    if (tapInFlight) return;
    tapInFlight = true;
    try {
      await doAction('/api/tap');
      tapCount += 1;
      document.getElementById('tapInfo').innerText = `–¢–∞–ø–æ–≤ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏: ${tapCount}`;
    } finally {
      tapInFlight = false;
    }
  }

  async function loadTop(kind) {
    const r = await fetch('/api/top/' + kind);
    const data = await r.json();
    const top = document.getElementById('top');
    top.innerHTML = `<h4>–¢–æ–ø-5: ${kind}</h4>` + data.items.map((x,i)=>
      `<div class='top-item'>${i+1}. user_id=${x.user_id} | üí∞ ${x.balance} | ü§ñ ${x.auto_farm_level} | üöÄ ${x.energy_regen}</div>`
    ).join('');
  }

  const tapZone = document.getElementById('tapZone');
  tapZone.addEventListener('click', doTap);
  tapZone.addEventListener('touchstart', (e) => {
    e.preventDefault();
    doTap();
  }, { passive: false });

  setupTelegramWebAppUser();
</script>
</body>
</html>
